<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBL 资料整理共享系统（GitHub+VS Code 版）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
        body { background: #f8f9fa; margin: 30px; }
        .container { max-width: 1100px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #2d3748; margin-bottom: 40px; border-bottom: 2px solid #007bff; padding-bottom: 15px; }
        h3 { color: #2d3748; margin: 25px 0 15px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500; }
        label.required::after { content: '*'; color: #dc3545; margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 16px; transition: border 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        textarea { min-height: 120px; resize: vertical; }
        .btn { padding: 10px 20px; margin-right: 10px; cursor: pointer; border: none; border-radius: 4px; font-size: 16px; transition: background 0.3s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .search-bar { display: flex; gap: 12px; align-items: center; margin: 20px 0; flex-wrap: wrap; }
        .search-bar select, .search-bar input { flex: 1; min-width: 180px; }
        .search-bar button { width: 110px; }
        .library { margin-top: 30px; }
        .library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .library-count { color: #007bff; font-weight: 600; }
        .library-item { border: 1px solid #e9ecef; padding: 20px; margin-bottom: 15px; border-radius: 6px; background: #fafafa; transition: box-shadow 0.3s; }
        .library-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .item-title { font-size: 18px; color: #2d3748; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .item-meta { color: #718096; font-size: 14px; margin-bottom: 8px; }
        .item-content { color: #4a5568; line-height: 1.6; margin-bottom: 12px; }
        .delete-btn { padding: 6px 12px; font-size: 14px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .delete-btn:hover { background-color: #c82333; }
        .bottom-btn-group { margin-top: 30px; text-align: center; }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .btn { margin-bottom: 10px; }
            .item-title { flex-direction: column; align-items: flex-start; gap: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PBL 资料整理共享系统</h1>

        <!-- 资料添加表单 -->
        <h3>添加 PBL 资料</h3>
        <form id="addForm">
            <div class="form-group">
                <label for="title" class="required">资料标题</label>
                <input type="text" id="title" placeholder="输入资料名称（如：《XX疾病诊疗指南》）" required>
            </div>

            <div class="form-group">
                <label for="category" class="required">资料分类</label>
                <select id="category" required>
                    <option value="">选择分类</option>
                    <option value="医学">医学</option>
                    <option value="论文期刊">论文期刊</option>
                    <option value="教材书籍">教材书籍</option>
                    <option value="行业指南">行业指南</option>
                    <option value="病例报告">病例报告</option>
                    <option value="教育">教育</option>
                    <option value="其他">其他</option>
                </select>
            </div>

            <div class="form-group">
                <label for="source" class="required">资料来源</label>
                <input type="text" id="source" placeholder="如：知网、UpToDate、《内科学》第9版" required>
            </div>

            <div class="form-group">
                <label for="validity" class="required">有效性说明</label>
                <textarea id="validity" placeholder="说明资料的权威性、相关性、时效性（如：中华医学会发布，2023年最新版，与PBL案例直接相关）" required></textarea>
            </div>

            <div class="form-group">
                <label for="summary">核心内容摘要</label>
                <textarea id="summary" placeholder="简要记录资料核心观点、关键数据、适用场景"></textarea>
            </div>

            <div class="form-group">
                <label for="usage">PBL 应用场景</label>
                <textarea id="usage" placeholder="说明该资料在PBL案例中的具体用途（如：支持疾病诊断依据、指导治疗方案制定、补充病理生理机制）"></textarea>
            </div>

            <button type="button" class="btn btn-primary" onclick="addToLibrary()">添加到资料库</button>
            <button type="button" class="btn btn-danger" onclick="clearForm()">清空表单</button>
        </form>

        <!-- 搜索区域 -->
        <div class="search-bar">
            <select id="searchCategory">
                <option value="">所有分类</option>
                <option value="医学">医学</option>
                <option value="论文期刊">论文期刊</option>
                <option value="教材书籍">教材书籍</option>
                <option value="行业指南">行业指南</option>
                <option value="病例报告">病例报告</option>
                <option value="教育">教育</option>
                <option value="其他">其他</option>
            </select>
            <input type="text" id="searchInput" placeholder="搜索资料标题/来源">
            <button class="btn btn-primary" onclick="searchLibrary()">搜索</button>
        </div>

        <!-- 资料库显示区域 -->
        <div class="library">
            <div class="library-header">
                <h3>资料库</h3>
                <span>共 <span id="libraryCount" class="library-count">0</span> 条资料</span>
            </div>
            <div id="libraryItems" class="data-list"></div>
        </div>

        <!-- 底部操作按钮 -->
        <div class="bottom-btn-group">
            <button type="button" class="btn btn-warning" onclick="exportLibrary()">导出《PBL资料来源表》</button>
            <button type="button" class="btn btn-danger" onclick="clearLibrary()">清空资料库</button>
        </div>
    </div>

    <script>
        // --------------- 关键修改：替换成你的 Gist 信息 ---------------
        const GIST_ID = "你的GistID"; // 替换成第二步的 Gist ID（如 abc123def456）
        const GIST_RAW_URL = "你的GistRaw链接"; // 替换成第二步的 Raw 链接
        // ---------------------------------------------------------------

        // GitHub Gist 访问需要的 Token（无需自己生成，用公开 Gist 即可）
        const GITHUB_TOKEN = ""; // 公开 Gist 无需填写，留空即可

        // 从 Gist 加载数据
        async function loadDataFromGist() {
            try {
                const response = await fetch(GIST_RAW_URL);
                if (!response.ok) throw new Error("加载数据失败");
                const data = await response.json();
                return data.library || [];
            } catch (error) {
                console.error("加载失败：", error);
                alert("加载资料出错，请刷新页面！");
                return [];
            }
        }

        // 保存数据到 Gist
        async function saveDataToGist(libraryData) {
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: "PATCH",
                    headers: {
                        "Accept": "application/vnd.github.v3+json",
                        "Content-Type": "application/json",
                        ...(GITHUB_TOKEN && { "Authorization": `token ${GITHUB_TOKEN}` })
                    },
                    body: JSON.stringify({
                        files: {
                            "pbl-library-data.json": {
                                content: JSON.stringify({ library: libraryData }, null, 2)
                            }
                        }
                    })
                });
                if (!response.ok) throw new Error("保存失败");
                return true;
            } catch (error) {
                console.error("保存失败：", error);
                alert("保存资料出错，请重试！");
                return false;
            }
        }

        // 初始化事件委托（删除功能）
        function initEventDelegate() {
            const libraryContainer = document.getElementById("libraryItems");
            libraryContainer.addEventListener("click", async function(e) {
                if (e.target.classList.contains("delete-btn")) {
                    const index = e.target.dataset.index;
                    if (confirm("确定删除这条资料吗？")) {
                        const libraryData = await loadDataFromGist();
                        libraryData.splice(index, 1);
                        const success = await saveDataToGist(libraryData);
                        if (success) {
                            alert("删除成功！");
                            updateLibraryDisplay(libraryData);
                        }
                    }
                }
            });
        }

        // 更新资料库显示
        function updateLibraryDisplay(libraryData) {
            const libraryContainer = document.getElementById("libraryItems");
            libraryContainer.innerHTML = "";
            document.getElementById("libraryCount").textContent = libraryData.length;

            if (libraryData.length === 0) {
                libraryContainer.innerHTML = '<div style="text-align: center; padding: 30px; color: #718096;">暂无资料，点击"添加到资料库"开始整理</div>';
                return;
            }

            libraryData.forEach((item, index) => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "library-item";
                itemDiv.innerHTML = `
                    <div class="item-title">
                        <span>${item.title}</span>
                        <small style="font-size: 14px; color: #718096; font-weight: normal;">${item.addTime}</small>
                    </div>
                    <div class="item-meta">分类：${item.category} | 来源：${item.source}</div>
                    <div class="item-content"><strong>有效性说明：</strong>${item.validity}</div>
                    <div class="item-content"><strong>核心摘要：</strong>${item.summary || "无"}</div>
                    <div class="item-content"><strong>PBL应用：</strong>${item.usage || "无"}</div>
                    <button class="delete-btn" data-index="${index}">删除</button>
                `;
                libraryContainer.appendChild(itemDiv);
            });
        }

        // 添加资料
        async function addToLibrary() {
            const title = document.getElementById("title").value.trim();
            const category = document.getElementById("category").value;
            const source = document.getElementById("source").value.trim();
            const validity = document.getElementById("validity").value.trim();
            const summary = document.getElementById("summary").value.trim();
            const usage = document.getElementById("usage").value.trim();

            if (!title || !category || !source || !validity) {
                alert("请填写所有标星号的必填项！");
                return;
            }

            const newEntry = {
                title, category, source, validity,
                summary: summary || "无",
                usage: usage || "无",
                addTime: new Date().toLocaleString()
            };

            const libraryData = await loadDataFromGist();
            libraryData.push(newEntry);
            const success = await saveDataToGist(libraryData);

            if (success) {
                alert("资料添加成功！所有人均可查看");
                clearForm();
                updateLibraryDisplay(libraryData);
            }
        }

        // 搜索功能
        async function searchLibrary() {
            const searchCategory = document.getElementById("searchCategory").value;
            const searchInput = document.getElementById("searchInput").value.toLowerCase().trim();

            const libraryData = await loadDataFromGist();
            const filteredData = libraryData.filter(item => {
                const matchCategory = searchCategory === "" || item.category === searchCategory;
                const matchText = item.title.toLowerCase().includes(searchInput) || item.source.toLowerCase().includes(searchInput);
                return matchCategory && matchText;
            });

            updateLibraryDisplay(filteredData);
        }

        // 导出CSV
        async function exportLibrary() {
            const libraryData = await loadDataFromGist();
            if (libraryData.length === 0) {
                alert("暂无资料可导出！");
                return;
            }

            let csvContent = "序号,资料标题,分类,来源,有效性说明,核心摘要,PBL应用场景,添加时间\n";
            libraryData.forEach((item, index) => {
                const formatStr = str => str.replace(/"/g, '""').replace(/\n/g, " ");
                csvContent += `${index + 1},"${formatStr(item.title)}","${formatStr(item.category)}","${formatStr(item.source)}","${formatStr(item.validity)}","${formatStr(item.summary)}","${formatStr(item.usage)}","${item.addTime}"\n`;
            });

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `PBL资料来源表_${new Date().toLocaleDateString()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert("导出成功！文件可直接用Excel打开");
        }

        // 清空资料库
        async function clearLibrary() {
            if (confirm("确定清空所有共享资料吗？所有人的数据都会删除，不可恢复！")) {
                const success = await saveDataToGist([]);
                if (success) {
                    alert("资料库已清空！");
                    updateLibraryDisplay([]);
                }
            }
        }

        // 清空表单
        function clearForm() {
            document.getElementById("addForm").reset();
        }

        // 页面初始化
        window.onload = async function() {
            initEventDelegate();
            const libraryData = await loadDataFromGist();
            updateLibraryDisplay(libraryData);
        };
    </script>
</body>
</html>